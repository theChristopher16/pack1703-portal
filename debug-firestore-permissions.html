<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Permission Debug</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBIBpkVqhPAJNYjymD-eK1n3ZuLwn9rf8g",
            authDomain: "pack1703-portal.firebaseapp.com",
            projectId: "pack1703-portal",
            storageBucket: "pack1703-portal.firebasestorage.app",
            messagingSenderId: "869412763535",
            appId: "1:869412763535:web:94b3b1ccc756ddfe92bdfa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        async function debugPermissions() {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                console.log('‚ùå No authenticated user');
                return;
            }

            console.log('‚úÖ User authenticated:', currentUser.email);
            console.log('User ID:', currentUser.uid);

            try {
                // Get custom claims
                const idTokenResult = await currentUser.getIdTokenResult();
                console.log('‚úÖ Custom claims:', idTokenResult.claims);
                console.log('Role from claims:', idTokenResult.claims.role);

                // Try to read user document
                console.log('\nüìã Attempting to read user document...');
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    console.log('‚úÖ User document exists:', userDoc.data());
                } else {
                    console.log('‚ùå User document does not exist');
                    console.log('üí° This might be the issue - user document missing');
                }

            } catch (error) {
                console.error('‚ùå Permission error:', error.code, error.message);
                console.error('Full error:', error);
                
                if (error.code === 'permission-denied') {
                    console.log('üí° This is the exact error you\'re seeing!');
                    console.log('üí° The user document either doesn\'t exist or the user doesn\'t have permission to read it');
                }
            }
        }

        // Monitor auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('üîê User signed in:', user.email);
                debugPermissions();
            } else {
                console.log('üîê User signed out');
            }
        });

        // Add login button
        window.loginWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                console.log('‚úÖ Google login successful');
            } catch (error) {
                console.error('‚ùå Google login failed:', error.code, error.message);
            }
        };
    </script>
</head>
<body>
    <h1>Firestore Permission Debug</h1>
    <button onclick="loginWithGoogle()">Login with Google</button>
    <div id="output" style="white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 10px; margin: 10px 0;"></div>
    <script>
        // Redirect console output to page
        const originalLog = console.log;
        const originalError = console.error;
        const output = document.getElementById('output');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            output.textContent += args.join(' ') + '\n';
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            output.textContent += 'ERROR: ' + args.join(' ') + '\n';
        };
    </script>
</body>
</html>

