rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user has any of the specified roles (multi-role support)
    function hasAnyRole(rolesList) {
      return isAuthenticated() && (
        request.auth.token.get('role', '') in rolesList ||
        request.auth.token.get('roles', []).hasAny(rolesList) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in rolesList ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('roles', []).hasAny(rolesList)
      );
    }
    
    function isAdmin() {
      // Multi-role aware admin check (includes den_leader and above)
      return hasAnyRole(['admin', 'super_admin', 'super-admin', 'den_leader', 'root', 'content-admin', 'copse_admin']);
    }
    
    function isSuperAdmin() {
      // Multi-role aware super admin check
      return hasAnyRole(['super_admin', 'super-admin', 'copse_admin', 'root']);
    }
    
    // TEMPORARY: Allow all authenticated users to read public data when App Check blocks access
    // This is a temporary workaround for App Check enforcement issues
    function isAuthenticatedUser() {
      return isAuthenticated();
    }
    
    function isValidTimestamp(ts) {
      return ts is timestamp && 
             ts > timestamp.date(2024, 1, 1) &&
             ts < timestamp.date(2030, 12, 31);
    }
    
    function isValidString(str, maxLength) {
      return str is string && 
             str.size() > 0 && 
             str.size() <= maxLength &&
             !str.matches('.*<[^>]*>.*'); // No HTML tags
    }
    
    function isValidEmail(email) {
      return email is string && 
             email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function getUserDenData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dens;
    }

    // ===== Multi-tenant helpers =====
    function isPlatformSuper() {
      return request.auth != null && request.auth.token.platform != null &&
             request.auth.token.platform.hasAny(['SUPER_ADMIN']);
    }
    function isRootRole() {
      return hasAnyRole(['root', 'super_admin', 'super-admin', 'copse_admin']);
    }
    function isSuperViaUserDoc() {
      return hasAnyRole(['root', 'super_admin', 'super-admin', 'copse_admin']);
    }
    function isSuper() { return isPlatformSuper() || isRootRole() || isSuperViaUserDoc(); }
    
    // Helper to check if user is member of household  
    function userInHousehold(householdId, userId) {
      return exists(/databases/$(database)/documents/sharedHouseholds/$(householdId)) &&
        get(/databases/$(database)/documents/sharedHouseholds/$(householdId)).data.ownerId == userId;
    }

    // ============================================================================
    // USER DATA SECURITY - Users can only access their own data
    // ============================================================================
    
    // Users collection - SECURE RULES (root account now exists)
    match /users/{userId} {
    // Users can read their own data
    allow read: if request.auth != null && request.auth.uid == userId;
    
    // Admins can read all users (for analytics and aggregation queries)
    allow read: if isAdmin();
    
    // Users can update their own profile (except role and permissions)
    // Root users can also update role, permissions, and isActive status
    allow update: if request.auth != null && 
                     request.auth.uid == userId;
    
    // Users can create their own user document (for new signups)
    // Super admin users can also create user documents for others
    allow create: if request.auth != null && 
                     (request.auth.uid == userId || 
                      hasAnyRole(['super_admin', 'super-admin', 'copse_admin']));
    
    // Only super admin users can delete users
    allow delete: if hasAnyRole(['super_admin', 'super-admin', 'copse_admin', 'root']);
  }
  
    // Allow aggregation queries on users collection for admins
    // Also allow limited queries for new user creation (checking if first user)
    match /users {
      allow read: if isAdmin();
      // Allow users to check if collection is empty (for first user detection)
      allow read: if isAuthenticated() && 
                     request.query.limit <= 1;
    }
  
  // Allow aggregation queries on announcements collection for admins
  match /announcements {
    allow read: if isAdmin();
  }
  
  // Fundraising data - read by authenticated users, write by Cloud Functions only
  match /fundraising/{document=**} {
    allow read: if isAuthenticated();
    allow write: if false; // Only Cloud Functions can write
  }
  
  // Allow aggregation queries on locations collection for admins
  match /locations {
    allow read: if isAdmin();
  }
  
  // Allow aggregation queries on categories collection for admins
  match /categories {
    allow read: if isAdmin();
  }
  
  // Allow aggregation queries on seasons collection for admins
  match /seasons {
    allow read: if isAdmin();
  }
    
    // Analytics - users can only access their own analytics data
    match /analytics/{analyticsId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Usage tracking - users can only access their own usage data
    match /usageTracking/{usageId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // User usage stats - users can only access their own stats
    match /userUsageStats/{userId} {
      allow read, write: if isAuthenticated() && 
        request.auth.uid == userId;
      allow create: if isAuthenticated() && 
        request.auth.uid == userId;
    }
    
    // Component analytics - authenticated users can read, admins can write
    match /componentAnalytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // RSVPs - users can only access their own RSVPs
    match /rsvps/{rsvpId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Allow admins to update paperwork status and payment status
      allow update: if isAuthenticated() && 
        hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']) &&
        request.resource.data.userId == resource.data.userId; // Can't change the user
    }
    
    // ============================================================================
    // PAYMENT SECURITY - Users can view their own payments, admins can manage all
    // ============================================================================
    
    match /payments/{paymentId} {
      // Users can read their own payment records
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Admins can read all payment records
      allow read: if isAuthenticated() && 
        hasAnyRole(['den_leader', 'admin', 'super_admin', 'root', 'copse_admin']);
      
      // Payment creation is handled by Cloud Functions only
      allow create: if false;
      
      // Admins can update payment records (for manual payment recording, refunds, etc.)
      allow update: if isAuthenticated() && 
        hasAnyRole(['admin', 'super_admin', 'root', 'copse_admin']) &&
        request.resource.data.userId == resource.data.userId; // Can't change the user
      
      // Only super admins can delete payments (for corrections)
      allow delete: if hasAnyRole(['super_admin', 'root', 'copse_admin']);
    }
    
    // Allow aggregation queries on payments collection for admins
    match /payments {
      allow read: if isAuthenticated() && 
        hasAnyRole(['den_leader', 'admin', 'super_admin', 'root', 'copse_admin']);
    }
    
    // Feedback - users can access their own feedback, den leaders+ can read all and respond
    match /feedback/{feedbackId} {
      // Users can read their own feedback
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Den leaders and up can read all feedback
      allow read: if isAuthenticated() && 
        hasAnyRole(['volunteer', 'admin', 'root', 'den_leader', 'super_admin', 'copse_admin']);
      // Users can create their own feedback
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Den leaders and up can update feedback (add responses)
      allow update: if isAuthenticated() && 
        hasAnyRole(['volunteer', 'admin', 'root', 'den_leader', 'super_admin', 'copse_admin']);
    }
    
    // Volunteer needs - authenticated users can read, admins can write
    match /volunteer-needs/{needId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Allow aggregation queries on volunteer-needs collection for authenticated users
    match /volunteer-needs {
      allow read: if isAuthenticated();
    }
    
    // Volunteer signups - users can access their own signups, admins can read all
    match /volunteer-signups/{signupId} {
      allow read: if isAuthenticated() && 
        (resource.data.volunteerUserId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() && 
        resource.data.volunteerUserId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.volunteerUserId == request.auth.uid;
    }
    
    // Allow aggregation queries on volunteer-signups collection for admins
    match /volunteer-signups {
      allow read: if isAdmin();
    }
    
    // User-pinned announcements - users can only access their own pins
    match /user-pinned-announcements/{pinId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // System logs - users can only access their own logs
    match /system-logs/{logId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // PUBLIC DATA - Readable by all authenticated users
    // ============================================================================
    
    // Events - authenticated users can read all events (visibility controlled at app level)
    // Public events are truly public, but authenticated users need access to all for proper filtering
    match /events/{eventId} {
      allow read: if isAuthenticated() || 
                     resource.data.visibility == 'public';
      allow write: if isAuthenticated() &&
                      isValidString(resource.data.title, 200) &&
                      isValidString(resource.data.description, 2000) &&
                      isValidTimestamp(resource.data.startDate) &&
                      isValidTimestamp(resource.data.endDate) &&
                      resource.data.startDate < resource.data.endDate;
    }
    
    // Allow aggregation queries on events collection for authenticated users
    match /events {
      allow read: if isAuthenticated();
    }
    
    // Announcements - den-based access for read, admin write
    match /announcements/{announcementId} {
      allow read: if isAdmin() || // Admins can read all
                     (!resource.data.targetDens || // No targeting = public
                      resource.data.targetDens.size() == 0) ||
                     (isAuthenticated() && 
                      resource.data.targetDens != null &&
                      resource.data.targetDens.size() > 0 &&
                      getUserDenData().hasAny(resource.data.targetDens));
      allow create: if isAdmin() &&
                      isValidString(request.resource.data.title, 200) &&
                      isValidString(request.resource.data.content, 5000);
      allow update: if isAdmin() &&
                      isValidString(resource.data.title, 200) &&
                      isValidString(resource.data.content, 5000);
      allow delete: if isAdmin();
    }
    
    // Locations - authenticated users can read, admin/super-admin can write
    match /locations/{locationId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() &&
                      isValidString(request.resource.data.name, 100) &&
                      isValidString(request.resource.data.address, 500);
      allow update: if isAdmin() &&
                      isValidString(resource.data.name, 100) &&
                      isValidString(resource.data.address, 500);
      allow delete: if isAdmin();
    }
    
    // Categories - public read, admin write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin() &&
                      isValidString(resource.data.name, 100);
    }
    
    // Seasons - public read, admin write
    match /seasons/{seasonId} {
      allow read: if true;
      allow write: if isAdmin() &&
                      isValidString(resource.data.name, 100) &&
                      isValidTimestamp(resource.data.startDate) &&
                      isValidTimestamp(resource.data.endDate) &&
                      resource.data.startDate < resource.data.endDate;
    }

    // ============================================================================
    // CHAT SYSTEM - Users can access channels they're part of
    // ============================================================================
    
    // Chat channels - authenticated users can read, admins can write
    match /chat-channels/{channelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Chat messages - all authenticated users can read/write
    match /chat-messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Chat users - users can read their own status, admins can read all
    match /chat-users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // Allow aggregation queries on chat-users collection for admins
    match /chat-users {
      allow read: if isAdmin();
    }

    // Pack lists - admin read/write, authenticated users read
    match /packLists/{listId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() &&
                      isValidString(resource.data.name, 100) &&
                      isValidString(resource.data.description, 500);
    }

    // Resources - public read, den leaders+ can write
    match /resources/{resourceId} {
      allow read: if true; // Public resources
      allow create: if isAuthenticated() && 
                       hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']) &&
                       isValidString(request.resource.data.title, 200) &&
                       isValidString(request.resource.data.description, 1000);
      allow update: if isAuthenticated() && 
                       hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']) &&
                       isValidString(resource.data.title, 200) &&
                       isValidString(resource.data.description, 1000);
      // Allow authenticated users to update download count and like count
      allow update: if isAuthenticated() && 
                       request.resource.data.downloadCount is number &&
                       request.resource.data.likeCount is number &&
                       request.resource.data.title == resource.data.title &&
                       request.resource.data.description == resource.data.description;
      allow delete: if isAuthenticated() && 
                       hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']);
    }
    
    // Allow aggregation queries on resources collection for admins
    match /resources {
      allow read: if isAdmin();
    }
    
    // User resource likes - users can manage their own likes
    match /user-resource-likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Allow aggregation queries on user-resource-likes for like status checks
    match /user-resource-likes {
      allow read: if isAuthenticated();
    }
    
    // Resource submissions - parents can submit, admins can review
    match /resource-submissions/{submissionId} {
      // Users can read their own submissions, admins can read all
      allow read: if isAuthenticated() && 
                     (resource.data.submittedBy == request.auth.uid || 
                      hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']));
      // Any authenticated user can create submissions
      allow create: if isAuthenticated() &&
                       request.resource.data.submittedBy == request.auth.uid &&
                       isValidString(request.resource.data.resourceTitle, 200) &&
                       isValidString(request.resource.data.submittedByName, 100) &&
                       isValidString(request.resource.data.fileName, 200);
      // Only admins can update (for reviews)
      allow update: if isAuthenticated() && 
                       hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']);
      // Users can delete their own submissions, admins can delete any
      allow delete: if isAuthenticated() && 
                       (resource.data.submittedBy == request.auth.uid || 
                        hasAnyRole(['volunteer', 'admin', 'super-admin', 'super_admin', 'root', 'den_leader', 'copse_admin']));
    }
    
    // Allow aggregation queries on resource-submissions
    match /resource-submissions {
      allow read: if isAuthenticated();
    }

    // ============================================================================
    
    // Admin audit logs - admin read-only
    match /admin/audit/{auditId} {
      allow read: if isAdmin();
      allow write: if false; // Audit logs are created by Cloud Functions only
    }
    
    // Allow aggregation queries on admin audit collection for admins
    match /admin/audit {
      allow read: if isAdmin();
    }
    
    // Admin actions - admins can write for logging
    match /adminActions/{actionId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Allow aggregation queries on admin actions collection for admins
    match /adminActions {
      allow read: if isAdmin();
    }
    
    // Audit logs - admins can write for logging
    match /auditLogs/{auditId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Allow aggregation queries on audit logs collection for admins
    match /auditLogs {
      allow read: if isAdmin();
    }
    
    // AI usage logs - admin read-only
    match /aiUsage/{usageId} {
      allow read: if isAdmin();
      allow write: if false; // AI usage logs are created by Cloud Functions only
    }
    
    // Allow aggregation queries on AI usage collection for admins
    match /aiUsage {
      allow read: if isAdmin();
    }
    
    
    // System metrics - admin read-only
    match /systemMetrics/{metricId} {
      allow read: if isAdmin();
      allow write: if false; // System metrics are created by Cloud Functions only
    }
    
    // Allow aggregation queries on system metrics collection for admins
    match /systemMetrics {
      allow read: if isAdmin();
    }
    
    // Performance metrics - admin read-only
    match /performanceMetrics/{metricId} {
      allow read: if isAdmin();
      allow write: if false; // Performance metrics are created by Cloud Functions only
    }
    
    // Allow aggregation queries on performance metrics collection for admins
    match /performanceMetrics {
      allow read: if isAdmin();
    }
    
    // Allow aggregation queries on system-logs collection for authenticated users
    match /system-logs {
      allow read: if isAuthenticated();
    }
    
    // Allow aggregation queries on chat-messages collection for authenticated users
    match /chat-messages {
      allow read: if isAuthenticated();
    }
    
    // Allow aggregation queries on chat-channels collection for authenticated users
    match /chat-channels {
      allow read: if isAuthenticated();
    }
    
    // Allow aggregation queries on rsvps collection for admins
    match /rsvps {
      allow read: if isAdmin();
    }
    
    // Allow aggregation queries on feedback collection for admins
    match /feedback {
      allow read: if isAdmin();
    }
    
    // Allow aggregation queries on analytics collection for authenticated users
    match /analytics {
      allow read: if isAuthenticated();
    }
    
    // AI interactions - admin read-only
    match /ai-interactions/{interactionId} {
      allow read: if isAdmin();
      allow write: if false; // AI interactions are created by Cloud Functions only
    }
    
    // AI confirmations - admin read-only
    match /ai-confirmations/{confirmationId} {
      allow read: if isAdmin();
      allow write: if false; // AI confirmations are created by Cloud Functions only
    }
    
    // Email monitor logs - admin read-only
    match /email-monitor-logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated(); // Allow authenticated users to log email activity
    }
    
    // Usage tracking - authenticated users can read/write their own data
    match /usageTracking/{usageId} {
      allow read, write: if isAuthenticated() && 
                          resource.data.userId == request.auth.uid;
      allow read: if isAdmin(); // Admins can read all usage data
    }
    
    // User usage stats - authenticated users can read/write their own data
    match /userUsageStats/{userId} {
      allow read, write: if isAuthenticated() && 
                          resource.id == request.auth.uid;
      allow read: if isAdmin(); // Admins can read all user stats
    }
    
    // Chat users - authenticated users can read/write their own data
    match /chat-users/{userId} {
      allow read, write: if isAuthenticated() && 
                          resource.id == request.auth.uid;
      allow read: if isAdmin(); // Admins can read all chat users
    }
    
    // Analytics - authenticated users can read/write their own data, admins can read all
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (resource.data.userId == request.auth.uid || 
                       request.resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Performance metrics - authenticated users can read/write their own data, admins can read all
    match /performance_metrics/{metricId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (resource.data.userId == request.auth.uid || 
                       request.resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Admin user management - admin only
    match /admin/users/{userId} {
      allow read, write: if isAdmin();
    }
    
    // System configuration - admin only
    match /system/{configId} {
      allow read: if isAdmin();
      allow write: if isRoot();
    }
    
    // Application configurations - admin read/write, authenticated users read
    match /configurations/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Volunteers collection - admin only
    match /volunteers/{volunteerId} {
      allow read, write: if isAdmin();
    }
    
    // Reminders - admin only
    match /reminders/{reminderId} {
      allow read, write: if isAdmin();
    }

    // ============================================================================
    // COST MANAGEMENT COLLECTIONS
    // ============================================================================
    
    // Cost tracking - admin only (using kebab-case to match service)
    match /cost-tracking/{trackingId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on cost tracking collection for admins
    match /cost-tracking {
      allow read: if isAdmin();
    }
    
    // Cost alerts - admin only (using kebab-case to match service)
    match /cost-alerts/{alertId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on cost alerts collection for admins
    match /cost-alerts {
      allow read: if isAdmin();
    }
    

    // ============================================================================
    // FINANCIAL MANAGEMENT COLLECTIONS - Admin only
    // ============================================================================
    
    // Financial transactions - admin only
    match /financial-transactions/{transactionId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on financial transactions for admins
    match /financial-transactions {
      allow read: if isAdmin();
    }
    
    // Financial accounts - admin only
    match /financial-accounts/{accountId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on financial accounts for admins
    match /financial-accounts {
      allow read: if isAdmin();
    }
    
    // Budget categories - admin only
    match /budget-categories/{categoryId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on budget categories for admins
    match /budget-categories {
      allow read: if isAdmin();
    }
    
    // Financial reports - admin only
    match /financial-reports/{reportId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on financial reports for admins
    match /financial-reports {
      allow read: if isAdmin();
    }
    
    // Financial goals - admin only
    match /financial-goals/{goalId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on financial goals for admins
    match /financial-goals {
      allow read: if isAdmin();
    }
    
    // Recurring transactions - admin only
    match /recurring-transactions/{recurringId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on recurring transactions for admins
    match /recurring-transactions {
      allow read: if isAdmin();
    }
    
    // Financial settings - admin only
    match /financial-settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on financial settings for admins
    match /financial-settings {
      allow read: if isAdmin();
    }


    // ============================================================================
    // MULTI-TENANT DATA
    // ============================================================================
    
    // Cross-organization users - users can only access their own records
    match /crossOrganizationUsers/{recordId} {
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Organizations - authenticated users can read, admins can write
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Secure tokens store (server-only)
    match /integrations_secure/{docId} {
      allow read, write: if false;
    }

    // ============================================================================
    // ACCOUNT REQUESTS - Admin only
    // ============================================================================
    
    // Account requests - admins can read and write
    match /accountRequests/{requestId} {
      allow read, write: if isAdmin();
    }
    
    // Allow aggregation queries on account requests collection for admins
    match /accountRequests {
      allow read: if isAdmin();
    }

    // ============================================================================
    // INVENTORY - Admin, super admin, content admin, and parent roles only
    // ============================================================================
    
    // Inventory items - admins, super admins, content admins, and parents can read and write
    match /inventory/{itemId} {
      allow read: if isAuthenticated() && (
        hasAnyRole(['super_admin', 'content_admin', 'parent', 'admin', 'copse_admin', 'den_leader']) ||
        isAdmin()
      );
      allow write: if isAuthenticated() && (
        hasAnyRole(['super_admin', 'content_admin', 'parent', 'admin', 'copse_admin', 'den_leader']) ||
        isAdmin()
      );
    }
    
    // Allow aggregation queries on inventory collection
    match /inventory {
      allow read: if isAuthenticated() && (
        hasAnyRole(['super_admin', 'content_admin', 'parent', 'admin', 'copse_admin', 'den_leader']) ||
        isAdmin()
      );
    }

    // ============================================================================
    // TEST COLLECTIONS (for monitoring and testing)
    // ============================================================================
    
    // Test connection collection - allow all access for testing
    match /_test_connection/{document} {
      allow read, write: if true;
    }
    
    // ============================================================================
    // SECURITY COLLECTIONS - SOC Console Data
    // ============================================================================
    
    // Security alerts - admin read-only
    match /securityAlerts/{alertId} {
      allow read: if isAdmin();
      allow write: if false; // Security alerts are created by Cloud Functions only
    }
    
    // Allow aggregation queries on security alerts for admins
    match /securityAlerts {
      allow read: if isAdmin();
    }
    
    // Threat intelligence - admin read-only
    match /threatIntelligence/{threatId} {
      allow read: if isAdmin();
      allow write: if false; // Threat intelligence is created by Cloud Functions only
    }
    
    // Allow aggregation queries on threat intelligence for admins
    match /threatIntelligence {
      allow read: if isAdmin();
    }
    
    // ============================================================================
    // BME680 SENSOR DATA & ECOLOGY
    // ============================================================================
    
    // BME680 environmental sensor readings
    match /bme680_readings/{readingId} {
      // Anyone can read (for Ecology Dashboard)
      allow read: if true;
      // Allow writes from anyone (ESP32 devices use API key, not auth)
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // General sensor readings
    match /sensor_readings/{readingId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // Camera images from ESP32-CAM
    match /camera_images/{imageId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // ============================================================================
    // USER INTERACTION TRACKING
    // ============================================================================
    
    // User interactions - Collection-level access
    // Super-admins can read all interaction data for analytics
    // All authenticated users can write their own interactions
    match /userInteractions {
      allow read: if isAuthenticated() && (
        hasAnyRole(['super_admin', 'super-admin', 'root', 'copse_admin'])
      );
      allow write: if false; // Only allow create on individual documents
    }
    
    // User interactions - Individual document access
    match /userInteractions/{interactionId} {
      // Users can create their own interaction records
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can read/update/delete their own interactions
      allow read, update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // FUNDRAISING MANAGEMENT
    // ============================================================================
    
    // Fundraising campaigns - Individual document access
    match /fundraising-campaigns/{campaignId} {
      // Anyone authenticated can read campaigns
      allow read: if isAuthenticated();
      
      // Only admins and den leaders can create/update/delete campaigns
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Fundraising campaigns - Collection access
    match /fundraising-campaigns {
      allow list: if isAuthenticated();
    }
    
    // Fundraising donations - Individual document access
    match /fundraising-donations/{donationId} {
      // Anyone authenticated can read donations
      allow read: if isAuthenticated();
      
      // Only admins and den leaders can create/update donations
      allow create, update: if isAdmin();
      
      // Only admins can delete donations
      allow delete: if isAdmin();
    }
    
    // Fundraising donations - Collection access
    match /fundraising-donations {
      allow list: if isAuthenticated();
    }

    // ============================================================================
    // GALLERY PHOTOS
    // ============================================================================
    
    // Gallery photos - Individual photo access
    match /gallery-photos/{photoId} {
      // Anyone authenticated can read approved photos
      // Den leaders and admins can read all photos (for approval)
      allow read: if isAuthenticated() && (
        resource.data.status == 'approved' ||
        hasAnyRole(['den_leader', 'admin', 'super_admin', 'copse_admin'])
      );
      
      // Any authenticated user can upload photos (pending approval)
      allow create: if isAuthenticated() &&
        request.resource.data.organizationId is string &&
        request.resource.data.uploadedBy == request.auth.uid &&
        request.resource.data.status == 'pending' &&
        request.resource.data.fileSize > 0 &&
        request.resource.data.fileSize < 10485760; // 10MB limit
      
      // Den leaders and admins can update photos (for approval/rejection/moving albums)
      // Photo uploader can update their own photos
      // Any authenticated user can update viewCount/viewedBy (for view tracking)
      allow update: if isAuthenticated() && (
        hasAnyRole(['den_leader', 'admin', 'super_admin', 'copse_admin']) ||
        resource.data.uploadedBy == request.auth.uid ||
        // Allow view count updates if only viewCount and viewedBy are being modified
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount', 'viewedBy', 'updatedAt']) &&
         request.auth.uid in request.resource.data.viewedBy) ||
        // Allow den leaders to move photos between albums
        (hasAnyRole(['den_leader', 'admin', 'super_admin', 'copse_admin']) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['albumId', 'updatedAt']))
      );
      
      // Photo uploader or admins can delete photos
      allow delete: if isAuthenticated() && (
        resource.data.uploadedBy == request.auth.uid ||
        hasAnyRole(['admin', 'super_admin', 'copse_admin'])
      );
    }
    
    // Gallery photos - Collection access
    match /gallery-photos {
      allow list: if isAuthenticated();
    }

    // ============================================================================
    // GALLERY ALBUMS
    // ============================================================================
    
    // Gallery albums - Individual album access
    match /gallery-albums/{albumId} {
      // Anyone authenticated can read albums
      allow read: if isAuthenticated();
      
      // Den leaders and above can create albums
      allow create: if isAuthenticated() &&
        hasAnyRole(['den_leader', 'admin', 'super_admin', 'copse_admin']) &&
        request.resource.data.organizationId is string &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Den leaders and above can update albums
      allow update: if isAuthenticated() &&
        hasAnyRole(['den_leader', 'admin', 'super_admin', 'copse_admin']);
      
      // Only admins can delete albums
      allow delete: if isAuthenticated() &&
        hasAnyRole(['admin', 'super_admin', 'copse_admin']);
    }
    
    // Gallery albums - Collection access
    match /gallery-albums {
      allow list: if isAuthenticated();
    }

    // ============================================================================
    // HOME MANAGEMENT - Groceries and Recipes
    // ============================================================================
    
    // Groceries - Users can only access their own grocery items
    match /groceries/{groceryId} {
      // Users can read their own groceries
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Super admins can read all groceries
      allow read: if isSuperAdmin();
      
      // Users can create their own grocery items
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own grocery items
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own grocery items
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Groceries - Collection access
    match /groceries {
      allow list: if isAuthenticated();
    }
    
    // Recipes - Users can only access their own recipes
    match /recipes/{recipeId} {
      // Users can read their own recipes
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Super admins can read all recipes
      allow read: if isSuperAdmin();
      
      // Users can create their own recipes
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own recipes
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own recipes
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Recipes - Collection access
    match /recipes {
      allow list: if isAuthenticated();
    }
    
    // Recipe use logs - Users can only access their own logs
    match /recipeUseLogs/{logId} {
      // Users can read their own logs
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Super admins can read all logs
      allow read: if isSuperAdmin();
      
      // Users can create their own logs
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Recipe use logs - Collection access
    match /recipeUseLogs {
      allow list: if isAuthenticated();
    }
    
    // Shopping Lists - Users can only access their own lists
    match /shoppingLists/{listId} {
      // Users can read their own lists
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Super admins can read all lists
      allow read: if isSuperAdmin();
      
      // Users can create their own lists
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own lists
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own lists
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Shopping Lists - Collection access
    match /shoppingLists {
      allow list: if isAuthenticated();
    }
    
    // Meal Plans - Users can only access their own plans
    match /mealPlans/{planId} {
      // Users can read their own plans
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Super admins can read all plans
      allow read: if isSuperAdmin();
      
      // Users can create their own plans
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own plans
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own plans
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Meal Plans - Collection access
    match /mealPlans {
      allow list: if isAuthenticated();
    }
    
    // Tasks - Users can only access their own tasks
    match /tasks/{taskId} {
      // Users can read their own tasks
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Super admins can read all tasks
      allow read: if isSuperAdmin();
      
      // Users can create their own tasks
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own tasks
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own tasks
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Tasks - Collection access
    match /tasks {
      allow list: if isAuthenticated();
    }
    
    // Home Preferences - Users can only access their own preferences
    match /homePreferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Household Profiles - Users can only access their own profile
    match /householdProfiles/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Calendar Integrations - Users can only access their own integrations
    match /calendarIntegrations/{integrationId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /calendarIntegrations {
      allow list: if isAuthenticated();
    }
    
    // Synced Calendar Events - Users can only access their own synced events
    match /syncedCalendarEvents/{eventId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only cloud functions can write
    }
    
    match /syncedCalendarEvents {
      allow list: if isAuthenticated();
    }
    
    // Calendar Credentials - Secure storage for API credentials (cloud functions only)
    match /calendarCredentials/{userId} {
      allow read, write: if false; // Only cloud functions can access
    }
    
    // === HOUSEHOLD SHARING ===
    
    // Shared Households
    match /sharedHouseholds/{householdId} {
      // Read if user is owner (simplified for now - members array checking is complex in rules)
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      // Create new household
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == request.auth.uid;
      
      // Update if user is owner
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      // Delete only by owner
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }
    
    // Household Invitations
    match /householdInvitations/{invitationId} {
      // Read if user is inviter or invitee
      allow read: if isAuthenticated() && 
        (resource.data.invitedBy == request.auth.uid || 
         resource.data.invitedEmail == request.auth.token.email);
      
      // Create invitation - allow if:
      // 1. User is the inviter (invitedBy == auth.uid)
      // 2. User is the owner of the household being invited to
      allow create: if isAuthenticated() && 
        request.resource.data.invitedBy == request.auth.uid &&
        exists(/databases/$(database)/documents/sharedHouseholds/$(request.resource.data.householdId)) &&
        get(/databases/$(database)/documents/sharedHouseholds/$(request.resource.data.householdId)).data.ownerId == request.auth.uid;
      
      // Update invitation (accept/decline by invitee)
      allow update: if isAuthenticated() && 
        resource.data.invitedEmail == request.auth.token.email;
      
      // Delete invitation (by inviter)
      allow delete: if isAuthenticated() && resource.data.invitedBy == request.auth.uid;
    }
    
    // User Households Mapping
    match /userHouseholds/{userId} {
      allow read, write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // Child Profiles
    match /childProfiles/{childId} {
      // Read if user is parent
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.parentUserIds;
      
      // Create by authenticated user
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.parentUserIds;
      
      // Update by parents only
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.parentUserIds;
      
      // Delete by parents only
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.parentUserIds;
    }
    
    // === SMART SHOPPING SYSTEM ===
    
    // Shopping Provider Configs
    match /shoppingProviders/{configId} {
      allow read, write: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid ||
         userInHousehold(resource.data.householdId, request.auth.uid));
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Shopping Carts
    match /shoppingCarts/{cartId} {
      allow read, write: if isAuthenticated() && 
        userInHousehold(resource.data.householdId, request.auth.uid);
      allow create: if isAuthenticated();
    }
    
    // Auto-Shopping Rules
    match /autoShoppingRules/{ruleId} {
      allow read, write: if isAuthenticated() && 
        userInHousehold(resource.data.householdId, request.auth.uid);
      allow create: if isAuthenticated();
    }
    
    // Order History
    match /orderHistory/{orderId} {
      allow read: if isAuthenticated() && 
        userInHousehold(resource.data.householdId, request.auth.uid);
      allow write: if false; // Only cloud functions can write
    }
    
    // === CROSS-ORGANIZATION SYNC ===
    
    // User Organization Memberships (cache)
    match /userOrganizationMemberships/{userId} {
      allow read, write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // Cross-Org Sync Preferences
    match /crossOrgSyncPreferences/{userId} {
      allow read, write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // Cross-Org Sync Status
    match /crossOrgSyncStatus/{userId} {
      allow read: if isAuthenticated() && userId == request.auth.uid;
      allow write: if false; // Only cloud functions update status
    }
    
    // Budget & Financial Collections
    match /expenses/{expenseId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /expenses {
      allow list: if isAuthenticated();
    }
    
    match /budgets/{budgetId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /budgetCategories/{categoryId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /savingsGoals/{goalId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Bills & Subscriptions
    match /bills/{billId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /bills {
      allow list: if isAuthenticated();
    }
    
    // Home Maintenance
    match /maintenanceItems/{itemId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /maintenanceItems {
      allow list: if isAuthenticated();
    }
    
    match /maintenanceLogs/{logId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Household Inventory
    match /inventoryItems/{itemId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /inventoryItems {
      allow list: if isAuthenticated();
    }
    
    // Family Events
    match /familyEvents/{eventId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /familyEvents {
      allow list: if isAuthenticated();
    }
    
    // Health & Medications
    match /medications/{medId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /healthAppointments/{apptId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /vaccinations/{vacId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Vehicle Management
    match /vehicles/{vehicleId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /vehicleMaintenance/{maintId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Pet Care
    match /pets/{petId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /petAppointments/{apptId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /petMedications/{medId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Documents
    match /documents/{docId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /documents {
      allow list: if isAuthenticated();
    }
    
    // Cleaning Schedule
    match /cleaningTasks/{taskId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    match /cleaningLogs/{logId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // DENY ALL OTHER ACCESS
    // ============================================================================
    
    // Note: Removed overly broad catch-all rule that was blocking all access
    // Specific rules above handle all necessary access patterns
  }
}