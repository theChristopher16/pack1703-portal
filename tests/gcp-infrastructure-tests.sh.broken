#!/bin/bash

# GCP Infrastructure Validation Tests - Working Version
# This script validates basic GCP resources without hanging

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test counters
PASSED=0
FAILED=0
SKIPPED=0

# Logging function
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

pass() {
    echo -e "${GREEN}‚úÖ PASS${NC} $1"
    PASSED=$((PASSED + 1))
}

fail() {
    echo -e "${RED}‚ùå FAIL${NC} $1"
    FAILED=$((FAILED + 1))
}

skip() {
    echo -e "${YELLOW}‚è≠Ô∏è  SKIP${NC} $1"
    SKIPPED=$((SKIPPED + 1))
}

# Header
echo "=========================================="
echo "GCP Infrastructure Validation Tests - Working"
echo "=========================================="
echo ""

# Check if gcloud is authenticated
log "Checking gcloud authentication..."
if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
    fail "gcloud not authenticated. Please run 'gcloud auth login'"
    exit 1
fi

# Get current project
PROJECT_ID=$(gcloud config get-value project 2>/dev/null || echo "")
if [ -z "$PROJECT_ID" ]; then
    fail "No GCP project set. Please run 'gcloud config set project <PROJECT_ID>'"
    exit 1
fi

log "Using GCP project: $PROJECT_ID"
echo ""

# Test 1: Project Status
log "Test 1: GCP Project Status"
if gcloud projects describe "$PROJECT_ID" >/dev/null 2>&1; then
    pass "Project exists and is accessible"
else
    fail "Project does not exist or is not accessible"
fi

# Test 2: Billing Status (simplified, no hanging)
log "Test 2: Billing Status"
if gcloud billing projects describe "$PROJECT_ID" --format="value(billingAccountName)" >/dev/null 2>&1; then
    pass "Billing is enabled"
else
    fail "Billing is not enabled"
fi

# Test 3: Required APIs (only check a few key ones)
log "Test 3: Required APIs"
KEY_APIS=("firebase.googleapis.com" "firestore.googleapis.com" "cloudfunctions.googleapis.com")

for api in "${KEY_APIS[@]}"; do
    if gcloud services list --enabled --filter="name:$api" --format="value(name)" | grep -q "$api"; then
        pass "API enabled: $api"
    else
        fail "API not enabled: $api"
    fi
done

# Test 4: Firebase Project
log "Test 4: Firebase Project"
if firebase projects:list 2>/dev/null | grep -q "$PROJECT_ID"; then
    pass "Firebase project exists"
else
    fail "Firebase project does not exist"
fi

# Test 5: Firebase Web Apps
log "Test 5: Firebase Web Apps"
WEB_APPS=$(firebase hosting:sites:list 2>/dev/null | grep -c "App ID" || echo "0")
if [ "$WEB_APPS" -gt 0 ]; then
    pass "Firebase web apps found: $WEB_APPS"
else
    skip "Firebase web apps not deployed yet"
fi    pass "Firestore database exists"
else
    fail "Firestore database does not exist"
fi

# Test 8: Firestore Indexes
log "Test 8: Firestore Indexes"
INDEXES=$(gcloud firestore indexes composite list --project="$PROJECT_ID" --format="value(name)" 2>/dev/null || echo "")
if [ -n "$INDEXES" ]; then
    pass "Firestore indexes found: $(echo "$INDEXES" | wc -l | tr -d ' ')"
else
    fail "No Firestore indexes found"
fi

# Test 9: Cloud Storage Buckets
log "Test 9: Cloud Storage Buckets"
BUCKET_COUNT=$(gsutil ls -p "$PROJECT_ID" 2>/dev/null | wc -l || echo "0")
if [ "$BUCKET_COUNT" -gt 0 ]; then
    pass "Cloud Storage buckets found: $BUCKET_COUNT"
else
    fail "No Cloud Storage buckets found"
fi

# Test 10: Secret Manager
log "Test 10: Secret Manager"
SECRETS=$(gcloud secrets list --project="$PROJECT_ID" --format="value(name)" 2>/dev/null | head -5 || echo "")
if [ -n "$SECRETS" ]; then
    pass "Secret Manager secrets found: $(echo "$SECRETS" | wc -l | tr -d ' ')"
else
    skip "No Secret Manager secrets found (this is optional)"
fi

# Summary
echo ""
echo "=========================================="
echo "Test Summary"
echo "=========================================="
echo -e "${GREEN}Passed: $PASSED${NC}"
echo -e "${RED}Failed: $FAILED${NC}"
echo -e "${YELLOW}Skipped: $SKIPPED${NC}"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}üéâ All basic infrastructure tests passed!${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Some basic infrastructure tests failed. Please review the errors above.${NC}"
    exit 1
fi
